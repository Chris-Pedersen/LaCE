\section{The emulator} \label{sec:emu}

For a given combination of linear power parameters $\theta$, i.e., for
each point in the lookup table, we want to compute the integral in
equation \ref{eq:marg}.
To do this, we need to specify priors $\Pi(\phi)$, but more importantly
we need to compute the likelihood $L(\vd | \theta, \phi)$.

We need, therefore, to make predictions for the 1D flux power spectrum
at a certain set of points, $P_{1D}(z,q)$, in velocity units, given a model
defined by ($\theta$,$\phi$).
We discuss the (nuisance) astrophysical parameters $\phi$ in more detail
later on, but for now we will assume that there are only two parameters:
an overall normalization of the logarithm of the mean flux $\ln{\bar F_0}$,
multiplying some fiducial redshift evolution, and an overall normalization
of the filtering length $k_{F 0}$ (associated to the smoothing of the gas),
also multiplying a fiducial redshift evolution. 


\subsection{Emulating a particular redshift}

For each redshift $z_i$, we compute the corresponding value of the mean flux
($\bar F_i$) and filtering length ($k_{Fi}$).

Using the linear power parameters ($\theta$), and the fiducial
power spectrum (in velocity units), we are able to compute the expected
linear power for this particular model, in velocity units, at this redshift,
$\tilde P_i(q)$.

\AFR{This is one of the pieces that is still not crystal clear in my head.
Would we just take $\tilde P_L(z_\star,q)$, the linear power in velocity
units at the central redshift, and rescale it using the discussion around
equation \ref{eq:growth}?
If we did that, we would be missing the fact that the transformation between
comoving and velocity separations $a_v$ changes with redshift.
I guess one could use the fiducial model to compute this difference?
The alternative would be to have a 6th cosmological parameter describing
the difference in the change in the Hubble expansion around $z_\star$?}
\as{If DE is truly negligible for sensible models, then just don't
  worry about it and assumed EdS. If it makes small corrections, then
  the best course of action would be to also specify $d
  H^2/da=-3\Omega_m/a^4$ at $z=z_\star$.}
\pvm{I think there is a key thing you (Andreu) should add to your thinking 
about these things: don't focus on the parameters you put in when running the
simulation, focus on the effective parameters you *achieve* for each redshift 
output, i.e., the numbers you can associate most directly with the flux power 
spectrum produced from that redshift output. 
E.g., there is a linear power spectrum associated with each redshift
output, which you can easily compute using CLASS -- you don't really care
where it came from in terms or evolution from higher z, or, if you do, it is 
only as a very subdominant correction.}
\NEW{Yes, I got that. That's what I was trying to say here...}
\pvm{Even if you decided you needed to 
track differences in evolution for fixed output-time linear power, you would
probably want to do that by extracting $dP_{lin}/dz(z_{output})$ 
from CLASS, i.e., 
keep everything you associate with an output local in $z$. Going on, there is
an $F(z_{out})$, there is a $T(z_{out})$, there is a $k_F(z_{out})$ -- 
there is no
need to talk about a ``fiducial z" at all at this level. You only need to think
about that at a higher level of fitting, when, e.g., you want to produce 
$\chi^2$ contours in $\Delta^2_L(z=3), \neff(z=3)$ plane (fixing linear power
at other z assuming some model), or you want to enforce physically reasonable
temperature evolution connecting $T(z)$, $k_F(z)$. This isn't an entirely 
non-trivial attitude. E.g., if you didn't think you could summarize pressure
by a $k_F(z)$ you could calculate for each output, maybe you'd want to 
associate a full temperature history with each output instead of only 
writing down local-in-z quantities, and then you might want to parameterize
that thermal history somehow, but I would worry about that only when pushed to
it (and probably it would always be better to invent some local-in-z quantity
you could compute to capture the physical effect you were missing). 
To put it another way: you want to separate your picture into things you can
calculate about the conditions in the Universe at a given z without sims 
(including if necessary derivatives) -- you want to take advantage of these
kinds of things
as much as possible -- and then a simulation mapping of those
things into non-linear power (in more or less arbitrary units, followed by 
observation, applying the necessary units -- this part I think is easy for
everyone to agree on). }
\NEW{Yes, that was my plan.}
\pvm{This is an opportunity to say something I've been thinking about all this 
including neutrino, etc., sim testing: by *far* the most efficient way to 
test whether an idea you have for simplifying the emulator parameterization is
good enough is
to just do the simple version and then see if it works in the case you think it
might not. Probably it will work, and if not you haven't lost anything since
you should just need to expand parameter space a little and add some sims to 
probe the new effect, still using what you have done (assuming it was sensible
and the addition is more or less perturbative).  }

\AFR{Pat, that is what I was trying to write... See discussion below, about
computing some quantities at the particular redshift, and then completely 
dropping the redshift altogether.}

\AFR{But I don't think I've got an answer to my question. 
We define a model, by choosing $\theta$ (linear power at $z_\star=3$, 
in $\kms$, and may be $f_\star$) and by choosing $\phi$ ($\bar F$, $k_F$...);
We then ask the emulator to give us the prediction for flux power spectrum
at $z=4$, and the emulator needs to figure out how to translate this model
($\theta$,$\phi$) to the parameters describing the simulations outputs, to 
figure out which one to use (imagine we have infinit simulations);
For the IGM parameters it is easy, we have a way to use $\phi$ parameters
and the fiducial evolution, and turn that into a prediction for 
$\bar F_i$ and $k_{F~i}$;
However, we also need a way to translate the $\theta$ parameters, and the 
fiducial cosmological model, to a linear power at $z_i=4$, in $\kms$. 
How do we do this? 
If we had still access to the full $P(z,k)$ and $H(z)$ that entered the 
user interface, that would be trivial. 
But we threw that information away because we claimed that the only thing 
that matters (the only parameters in our final likelihood) were there 
$\theta$ parameters.
So we need to be able to reconstruct any linear power from these, so that 
then we can look at the simulations and try to look for a "snapshot" 
(more precisely, one of the multiple reproccessed snapshots) that had 
this particular power spectrum.
I'm not sure this is any clearer... 
}
\pvm{*For the emulator*, who says you need to ``define a model" by choosing 
power at $z_\star=3$? Where by ``emulator" I mean this thing that takes 
some kind of relatively easy to compute quantities and produces what it thinks
would be simulation results given them. Maybe it is easiest to think of it 
by sort of back-propagation: you have a 1D flux power spectrum measurement at 
$z=4$, you need a prediction for it, what does your emulator need to know to 
predict it? I'd say at first approximation it needs to know $P(k,z=4)$, in 
km/s. So the input to the emulator is $P(k,z=4)$ in km/s, period, end of 
story for emulator -- it has a hard enough job doing this well, it doesn't
need to worry about where this $P(k in km/s,z=4)$ came from. }
\NEW{Yes, I agree. I realize now that I was using the word \textit{emulator}
in the wrong way, including what you call bellow "code to make a $\chi^2$ 
table".}
\pvm{If you're asking
like ``how would I use this emulator to make a $\chi^2$ table of final results 
for $\Delta^2,\neff(z=3,k=0.009 s/km)$", worrying about broader z (and k) 
dependence,
I think you just pick the current best cosmological model as fiducial, and
define $\Delta^2,\neff(z=3,k=0.009 s/km)$ effectively as variations of 
$A_s$ and $n_s$ -- this gives you your $P(k in km/s,z=4)$ to feed the 
emulator, but it is really a completely separate thing from the emulator. }
\NEW{Just to be sure. $\theta$ parameters describe the different shape of the 
linear power, in $\kms$, at $z_\star=3$. 
I can try to use these, and $H^0(z_\star)$ from the fiducial model, to compute 
the equivalent linear power in comoving coordinates.
Then I can translate that to a different redshift using the linear growth
of the fiducial model (may be corrected by difference in $f_\star$), and 
then use the Hubble parameter of the fiducial model at the redshift, 
$H^0(z_i=4)$ to compute the final power we needed to talk to the simulations.
Correct? The only thing this could break is if the redshift evolution of 
$H(z)$ and $H^0(z)$ were very different, but that should not be the case for
most models, and if it was we could add an extra parameter to take care of 
this. Did I understand it?}
\pvm{Of course, maybe you want to fit for growth deviations, and this gives you 
a different way of getting $P(k in km/s,z=4)$, or maybe you are doing a big
global MCMC chain... the emulator who's job is to predict 
1D flux power at z=4 doesn't want to know what you are doing globally, it 
just wants to know $P(k in km/s,z=4)$... (I've been writing 
$P(k in km/s,z=4)$ because I carefully wrote 1D power and it is shorter than
writing ``$P(k in Mpc,z=4)$ and $H(z=4)$", which I think we agree is probably
how things should really go for pedagogical reasons, and 
add $D_A(z=4)$ for 3D.) }
\NEW{Ok, I think we are getting closer. I think part of the confusion was 
my poor use of the word \textit{emulator}, and the other part of the confusion
is that I always wanted to focus on the "look-up table" version, and not on 
the cosmomc version.}



At this point, we can completely forget about the redshift $z_i$.

Instead, we will go to our simulation database, and ask:
is there any simulated flux power spectra that was computed from a snapshot
with similar linear power (in velocity units) $\tilde P_i(q)$, similar
mean flux $\bar F_i$ and similar filtering length $k_{Fi}$? \as{And
  similar $f$ for velocity effects? Again, only matters if non-EdS matters.}
\pvm{Remember that much of non-EdS effects can still be accounted for by just
linear theory. } \as{But it changes growth, which in turn changes
velocity smoothing. So yes, linear power spectrum but also most likely
its time derivative (or equivalently velocity power spectrum)} \pvm{Thinking of neutrinos, I think it is really best to get away
from talking about $f(z)$, which is not well-defined when it is really 
$f(z,k)$. 
Remember that you can easily compute from CLASS the velocity power spectrum as
well as density, which gives you your leading order handle on changes in 
evolution... (arguably if you had to choose you'd probably want this instead
of density power for LyaF, but you don't have to choose...)}
\AFR{Yes, we could add linear velocity power instead of $f(z)$, and compute
from there any parameter we want to use internally.}

If we had an extremely large number of simulations, we could just setup a
metric to find the closest snapshot, and directly read the flux power
from the snapshot.
Since we will have a sparse sampling of the parameter space, we will need
to do some interpolation between them. \as{This is a good way to think
  about this, yes.}
This interpolation is precisely the role of the \textit{emulator}.

Note that the internal metric used for the interpolation does not need to 
use the same parameters $\theta$ describing the linear power.

